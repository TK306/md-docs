# 外部設計仕様書

## 目的と適用範囲

この文書はライブラリの「公開 API（利用者が参照・使用する契約）」に焦点を当てます。実装の内部構成やファイル配置の詳細は内部設計仕様書に委ね、ここでは利用者にとって重要なインターフェースのシグネチャと振る舞いだけを記載します。

## 目次（抜粋）

- **概要**: 目的と高レベルな振る舞い
- **対象ユーザ・ユースケース**: 期待される操作フロー
- **入出力仕様**: フロントマターとノードのユーザ向け振る舞い（契約）
- **公開 API**: `mddocs.api` に含まれる公開 API とその契約
- **エラーと検証ルール**: 利用者が対処すべき条件と例外メッセージ
- **利用例**: 簡潔な利用シナリオ（コード断片）

## 概要

`md-docs` は Markdown とドメインモデル（ユーザ実装の `DocConvertible`）との相互変換を助けるライブラリです。内部では Markdown を中間表現（IR: `Document` と `DocNode` 系）へ変換し、そこからモデルの生成・復元を行います。利用者は基本的に `mddocs.api` の公開関数・型を参照します。

## 対象ユーザ・ユースケース

- **対象ユーザ**: Markdown ファイルを構造化データへマッピングしたい開発者、ライブラリ利用者
- **主要ユースケース**:
	- Markdown ファイルを読み込み、ドメインモデルへ変換する
	- ドメインモデルから Markdown を生成して保存する
	- 独自のストレージやパーサを注入して差し替える（高度利用者向け）

## 入出力仕様（利用者視点、抜粋）

- **フロントマター**: HTML コメント形式（先頭 `<!--`、末尾 `-->`）で記述されたキー: 値を `Document.front_matter: dict[str,str]` として扱います。パース後のフロントマターは `DocConvertible.from_nodes(..., front_matter=...)` に渡されます。

- **本文ノード**: 利用者が扱う中間表現には以下のノードが含まれます: `Heading(level, text)`, `Paragraph(text)`, `BulletList(items)`, `NumberedList(items)`, `Table(headers, rows)`, `Image(alt, path)`。

- **表（Table）**: `Table.headers: list[str]`, `Table.rows: list[list[str]]`。ユーティリティ `Table.as_dict(ignore_extra_columns: bool = False) -> dict[str,str]` により簡易なキー/値テーブルを取得できます（仕様: 各行は少なくとも2列、3列以上はデフォルトでエラー、重複キーはエラー）。

## 公開 API（`mddocs.api`：利用者が参照する契約）

外部設計で記載するのは API の契約（関数名・引数・期待される振る舞い/例外）です。実装場所は `mddocs.api` に集約されています。

- `dump_markdown(model: DocConvertible, path: str | Path) -> None`:
	- 役割: モデルを Markdown に変換して `path` に保存する単純なユーティリティ。
	- 振る舞い: デフォルトのパーサ/レンダラ/ストレージを内部で使用するが、詳細な実装は内部に隠蔽される。失敗時は IOError やレンダリング例外をそのまま伝搬する。

- `DocConvertible`（抽象契約）:
	- `to_nodes(self) -> list[DocNode]`
	- `@classmethod from_nodes(cls, nodes: list[DocNode], front_matter: dict[str,str] | None = None) -> T`
	- `to_front_matter(self) -> dict[str,str]`（任意実装、デフォルトは空辞書）

- `nodes` 名前空間: 利便性のため `Table` 等の型が `mddocs.api.nodes`（およびトップレベルの再エクスポート）で参照可能です。

注意: ここで示す API は契約です。具体的なクラス名やファイルパス（`src/adapters/*` など）は実装の話なので外部設計には列挙しません。

## エラーと検証ルール（利用者に見えるもの）

- `MarkdownParseError`: 入力の構文が不正な場合に発生。メッセージは該当行と原因を含む。
- `ValueError` (Table.as_dict): 行長不足や重複キーなどの検証エラー。
- ストレージ関連の IOError / OSError: ファイルアクセス失敗時に発生。

## 非機能要件

- **整形**: 最終的な Markdown 出力は `mdformat` によって整形されることを期待します。
- **互換性**: 単純な Markdown 構文（見出し、段落、リスト、表、画像）に対応します。拡張 Markdown 機能は将来的に拡張可能ですが本設計では対象外です。
- **副作用**: ドメイン層 (`DocConvertible` 等) は副作用を持たず、ファイル上書き等はユースケース/アダプタで制御されます。

## 利用例（簡潔）

```python
from dataclasses import dataclass
from mddocs import DocConvertible, dump_markdown
from mddocs.api.nodes import Table

@dataclass
class MddocsTest(DocConvertible):
	name: str
	value: int

	def to_nodes(self):
		return [Table(headers=["Name", "Value"], rows=[[self.name, str(self.value)]])]

	@classmethod
	def from_nodes(cls, nodes, front_matter=None):
		# 実装は省略
		...

test_doc = MddocsTest(name="Sample", value=42)
dump_markdown(test_doc, "output.md")
```

## 操作フロー（利用者視点）

1. ユーザは Markdown ファイルを用意する（例: `input.md`）。
2. ユーザは Markdown ファイルに対応する dataclass を `mddocs.DocConvertible` を継承して実装する。
3. ライブラリの公開 API（`mddocs.dump` 等）を利用し、ユーザ構造体と Markdown ファイルを相互変換する。
