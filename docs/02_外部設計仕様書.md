# 外部設計仕様書

## 目次

- **概要**: 本ツールの目的と高レベルな振る舞い
- **対象ユーザ・ユースケース**: 想定する利用者と主な操作フロー
- **入出力仕様**: Markdown 入出力のフォーマット、フロントマター、表の扱い
- **公開 API / CLI インターフェース**: アダプタ層の公開メソッドと呼び出し仕様
- **エラーと検証ルール**: ユーザに見えるエラー条件とメッセージ
- **非機能要件**: 性能、整形、互換性など
- **利用例**: 入力 Markdown と期待される Document / JSON 表現の例
- **変更履歴**

---

## 概要

`md-docs` は Markdown と任意の構造体（ユーザ定義の dataclass）との相互変換を支援するライブラリです。内部では Markdown を中間表現（IR: `Document` と `DocNode` 系）に変換し、そこからユーザが実装する `DocConvertible` サブクラスとの相互変換を行います。

本製品は内部設計としてクリーンアーキテクチャ（Ports & Adapters）を前提にしています。外部設計では実装の細部を隠蔽しつつ、利用者がどのインターフェース（ポート）を使えば良いかを明確に示します。実装者向けの詳細（モジュール名やファイル構成）は内部設計仕様書を参照してください。

## 対象ユーザ・ユースケース

- **対象ユーザ**: ドキュメントをコード内データ構造にマッピングしたいライブラリ作者、ツールユーザ
- **主要ユースケース**:
	- Markdown ファイルを読み込み、`Document`（中間表現）に変換する
	- `Document` を利用してユーザ定義クラス（`DocConvertible` を継承）を生成する
	- ユーザオブジェクトから `Document` を生成し Markdown をレンダリングする
	- ストレージ（ファイル）からの読み書きを `Storage` によって抽象化する

## 入出力仕様

- **フロントマター** (`SPEC-FM-001`): HTML コメント形式（先頭に `<!--`、末尾に `-->`）でキーバリューを1行ずつ記述します。例: `<!--\nkey: value\n-->`。パーサは各行を `':'` で分割して `Document.front_matter: dict[str,str]` として保持します。
- **本文ノード** (`SPEC-NODES-001`): パーサは以下の `DocNode` を生成します（`src/domain/doc_ir.py` を参照）: `Heading(level, text)`, `Paragraph(text)`, `BulletList(items)`, `NumberedList(items)`, `Table(headers, rows)`, `Image(alt, path)`。
-- **表（Table）** (`SPEC-TABLE-001`):
	- Markdown 形式の表を `Table.headers: list[str]`, `Table.rows: list[list[str]]` として保持します。
	- アプリケーションレベルで「表を辞書に変換する」ユースケースがあるため、`Table.as_dict(ignore_extra_columns: bool = False) -> dict[str,str]` が提供されます。振る舞いの要点:
		- 各行は少なくとも 2 列必要。2 列未満は `ValueError`。
		- 3 列以上はデフォルトで `ValueError`。`ignore_extra_columns=True` で余分な列を無視して変換可能。
		- 左列をキー、右列を値とする。重複キーは `ValueError`。

## 公開 API / CLI インターフェース

本ライブラリはクリーンアーキテクチャの「ポート（抽象）」を公開し、具体実装（アダプタ）は入れ替え可能になるよう設計されています。利用者が直接使う主要なポートは以下です。

- **パーサ（ポート）** (`SPEC-PARSER-001`) — 文字列（Markdown）から `Document` を生成します。
	- 例: `MarkdownParserAdapter.parse(text: str) -> Document`（実装例）
	- 例外: 構文エラー時は `MarkdownParseError`
- **レンダラ（ポート）** (`SPEC-RENDER-001`) — `Document` を Markdown 文字列に変換します。
	- 例: `MarkdownRendererAdapter.render(doc: Document) -> str`（実装例。内部で整形器を呼ぶ可能性あり）
- **ストレージ（ポート）** (`SPEC-STORAGE-001`) — ファイルや外部ストレージの読み書きを抽象化します。
	- 例: `FileStorage.read(path: Path) -> str` / `FileStorage.write(path: Path, content: str) -> None`（実装例）
- **ドメイン変換契約（ポート）** (`SPEC-DOMAIN-001`) — ユーザ側は `DocConvertible` を実装してドメイン↔ノード変換を定義します。
	- `to_nodes(self) -> list[DocNode]`
	- `@classmethod from_nodes(cls, nodes: list[DocNode]) -> T`

注: 具体実装（`src/adapters` 内のクラス）は「アダプタ」としてポートを実装します。使用者はポートのシグネチャ（上記）を使えば良く、実装の差し替えやモック注入が可能です。

## エラーと検証ルール（ユーザに見えるもの）

- **構文エラー**: Markdown の構文が想定外の場合、`MarkdownParseError` を返します。メッセージは行番号と問題点を含めます。
- **表関連の検証**: `Table.as_dict` 実行時に列数や重複キーに関して `ValueError` を返します。呼び出し側は必要に応じ `ignore_extra_columns=True` を付与してください。
- **レンダリング失敗**: `MarkdownRendererAdapter.render` は内部で `mdformat` を使います。整形中にエラーがあると例外が伝搬します。

## 非機能要件

- **整形**: 最終的な Markdown 出力は `mdformat` によって整形されることを期待します。
- **互換性**: 単純な Markdown 構文（見出し、段落、リスト、表、画像）に対応します。拡張 Markdown 機能は将来的に拡張可能ですが本設計では対象外です。
- **副作用**: ドメイン層 (`DocConvertible` 等) は副作用を持たず、ファイル上書き等はユースケース/アダプタで制御されます。

## 利用例

- 入力 Markdown:

```
<!--
title: サンプル
--> 

# 設定

| key | value |
| --- | --- |
| name | example |
| version | 1.0 |

Some paragraph text.
```

- 期待される `Document` の概念表現（擬似 Python 表記）:

```
Document(
	front_matter={"title":"サンプル"},
	nodes=[
		Heading(level=1, text="設定"),
		Table(headers=["key","value"], rows=[["name","example"],["version","1.0"]]),
		Paragraph(text="Some paragraph text.")
	]
)
```

- ユーザーコードで定義される構造体


```python 
@dataclass
class Sample(DocConvertible):
    name: str
    version: str
    comment: str

    @abstractmethod
    def to_nodes(self) -> list[DocNode]:
        # 単純な実装で、Sample→DocNodeへの変換方法を定義できる。
        return [
            Heading(level=1, text="設定"),
            Table(headers=["key","value"], rows=[["name",self.name],["version",self.version]]),
            Paragraph(text=self.comment)
        ]

    @classmethod
    @abstractmethod
    def from_nodes(cls, nodes: list[DocNode]) -> "Sample":
        # 単純な実装で、DocNode→Sampleのパース方法を定義できる。実装方法はTBD
```

## 変更履歴

- 2025-12-27: 初版（実装を参照して作成）

## 操作フロー（利用者視点）

- 1. ユーザは Markdown ファイルを用意する（例: `input.md`）。
- 2. ライブラリの公開 API（または CLI）を呼び出し、ファイルを読み込む。ライブラリは `Document` を返すか、ユーザ実装の `DocConvertible` を生成する。
- 3. ユーザは得られたオブジェクトを操作し、必要に応じ `to_nodes()` を呼び出して Markdown を再生成する。
- 4. 生成した Markdown をストレージへ保存する（`Storage` 実装を利用）。

## CLI / 公開 API の簡易使用例

## エラーとユーザ向けメッセージ（例）

- `MarkdownParseError`: "Invalid markdown at line {n}: {reason}" — 入力の構文エラー
- `ValueError` (Table.as_dict): "Table row {i} has fewer than 2 columns" / "duplicate key found: '{key}'" — 表の変換エラー
- `Storage` エラー: ファイル読み書きの失敗は I/O 層で捕捉し、利用者に適切なファイルアクセスエラーを返す想定

## 互換性・制限

- 対応 Markdown 機能は限定的です（見出し、段落、箇条書き、番号リスト、テーブル、画像）。
- GitHub Flavored Markdown の拡張構文（コードブロック内メタ情報、詳細なテーブル機能等）は本バージョンでは対象外です。

## 将来の拡張ポイント（利用者に影響する変更）

- パーサ/レンダラの拡張により一部 Markdown の解釈が変わる可能性があるため、重大な互換性変更はメジャーバージョンで管理すること。
- `Table.as_dict` の挙動変更（例えば複数列対応やキーの合成）は上位 API（ユースケース）側で段階的に導入する。


